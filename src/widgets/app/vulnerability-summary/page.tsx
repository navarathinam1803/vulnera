'use client';

import { useTheme, useMaxHeight, useWidgetSDK } from '@nitrostack/widgets';
import { FileText } from 'lucide-react';
import { SeverityBadge } from '../../components/SeverityBadge';

export const dynamic = 'force-dynamic';

const SEVERITY_ORDER = ['critical', 'high', 'moderate', 'low', 'info'] as const;

interface WidgetData {
    summary: string;
    bySeverity: Record<string, string[]>;
    total: number;
}

export default function VulnerabilitySummaryWidget() {
    const theme = useTheme();
    const maxHeight = useMaxHeight();
    const isDark = theme === 'dark';
    const { isReady, getToolOutput } = useWidgetSDK();
    const data = getToolOutput<WidgetData>();

    const border = isDark ? 'rgba(255,255,255,0.12)' : 'rgba(0,0,0,0.12)';

    const purple = isDark ? '#ba68c8' : '#7b1fa2';

    if (!data) {
        return (
            <div
                style={{
                    padding: '40px',
                    textAlign: 'center',
                    color: isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.6)',
                    background: isDark ? 'rgba(123, 31, 162, 0.15)' : 'rgba(123, 31, 162, 0.06)',
                    minHeight: '200px',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    justifyContent: 'center',
                    gap: '12px',
                    borderRadius: '8px',
                    border: `1px solid ${border}`,
                }}
            >
                <FileText size={40} style={{ color: purple }} />
                <span>Loading vulnerability summary… {isReady ? '(no data yet)' : '(waiting for SDK)'}</span>
            </div>
        );
    }

    const { summary, bySeverity, total } = data;

    return (
        <div
            style={{
                background: isDark ? 'rgba(123, 31, 162, 0.05)' : 'rgba(123, 31, 162, 0.03)',
                minHeight: '280px',
                maxHeight: maxHeight || '600px',
                overflow: 'auto',
                padding: '16px',
            }}
        >
            <div
                style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px',
                    marginBottom: '16px',
                    padding: '8px 12px',
                    background: isDark ? 'rgba(123, 31, 162, 0.2)' : 'rgba(123, 31, 162, 0.12)',
                    borderRadius: '8px',
                    width: 'fit-content',
                }}
            >
                <FileText size={22} style={{ color: purple }} />
                <h1 style={{ margin: 0, fontSize: '18px', fontWeight: 500, color: purple }}>
                    Vulnerability summary
                </h1>
                {total > 0 && (
                    <span style={{ marginLeft: '8px', fontSize: '13px', color: purple, opacity: 0.9 }}>
                        {total} finding{total !== 1 ? 's' : ''}
                    </span>
                )}
            </div>

            {/* Human-readable summary */}
            <div
                style={{
                    padding: '16px',
                    background: isDark ? 'rgba(156, 39, 176, 0.12)' : 'rgba(156, 39, 176, 0.08)',
                    border: `1px solid ${isDark ? 'rgba(186, 104, 200, 0.4)' : 'rgba(123, 31, 162, 0.3)'}`,
                    borderRadius: '8px',
                    marginBottom: '16px',
                    whiteSpace: 'pre-wrap',
                    fontSize: '14px',
                    lineHeight: 1.6,
                    color: isDark ? 'rgba(255,255,255,0.87)' : 'rgba(0,0,0,0.87)',
                    boxShadow: isDark ? '0 1px 3px rgba(0,0,0,0.2)' : '0 1px 3px rgba(0,0,0,0.08)',
                }}
            >
                {(typeof summary === 'string' ? summary : '').replace(/\*\*/g, '')}
            </div>

            {/* By severity */}
            {total > 0 &&
                SEVERITY_ORDER.map((sev) => {
                    const list = bySeverity[sev];
                    if (!list || list.length === 0) return null;
                    return (
                        <div key={sev} style={{ marginBottom: '16px' }}>
                            <div
                                style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '8px',
                                    marginBottom: '8px',
                                }}
                            >
                                <SeverityBadge
                                    severity={sev}
                                    isDark={isDark}
                                />
                                <span style={{ fontSize: '12px', color: isDark ? '#737373' : '#6b7280' }}>
                                    {list.length} item{list.length !== 1 ? 's' : ''}
                                </span>
                            </div>
                            <ul
                                style={{
                                    margin: 0,
                                    paddingLeft: '20px',
                                    fontSize: '13px',
                                    lineHeight: 1.5,
                                    color: isDark ? '#d4d4d4' : '#4b5563',
                                }}
                            >
                                {list.slice(0, 5).map((line, i) => (
                                    <li key={i} style={{ marginBottom: '4px' }}>
                                        {line}
                                    </li>
                                ))}
                                {list.length > 5 && (
                                    <li style={{ color: isDark ? '#737373' : '#9ca3af' }}>
                                        … and {list.length - 5} more
                                    </li>
                                )}
                            </ul>
                        </div>
                    );
                })}
        </div>
    );
}
